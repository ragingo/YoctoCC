# Yoctocc テストフレームワーク

このディレクトリには、chibiccスタイルのユニットテスト機構が含まれています。

## 使用方法

### テストの実行

プロジェクトルートから以下のコマンドを実行:

```bash
make test
```

### テストの追加

テストは2つの方法で追加できます:

#### 方法1: ファイルベース (推奨)

`test/cases/` ディレクトリ以下に `.c` ファイルを作成します。

**ファイル構造**:
```
test/
├── cases/
│   ├── basic/           # 基本的なテスト
│   ├── comment/         # コメント関連
│   ├── control_flow/    # 制御構文
│   ├── function/        # 関数呼び出し
│   ├── gnu/             # GNU拡張
│   └── ...
```

**ファイルフォーマット**:
```c
// EXPECTED: <期待される終了コード>
int main() {
    return 42;
}
```

**例** (`test/cases/basic/return_42.c`):
```c
// EXPECTED: 42
int main() { return 42; }
```

**メリット**:
- 可読性が高い (シンタックスハイライト、整形)
- 複雑な複数行のテストケースに対応
- エディタで編集しやすい
- カテゴリ別に整理できる

#### 方法2: インラインテスト (後方互換)

`test/tests.conf` に1行で記述します。

**フォーマット**: `<期待される終了コード> <コード>`

**例**:
```
42 int main() { return 42; }
8 int main() { int a=3; int z=5; return a+z; }
```

### テストの実行順序

1. `test/cases/` 内の `.c` ファイル (アルファベット順)
2. `test/tests.conf` のインラインテスト (記述順)

### 並列実行

テストは自動的に並列実行されます。並列数は CPU コア数に基づいて決定されます。
カスタマイズする場合:

```bash
PARALLEL_JOBS=4 make test
```

## ファイル構成

- `cases/` - ファイルベースのテストケース
- `tests.conf` - インラインテスト設定ファイル (後方互換)
- `run_tests_parallel.sh` - 並列テスト実行スクリプト
- `test_helper.c`, `test_helper.h` - テストヘルパー関数
- `README.md` - このファイル
test/test1.txt 100 "基本的な式と制御構文のテスト"
test/test2.txt 0 "正常終了のテスト(return 0)"
test/test3.txt 1 "return 1のテスト"
```

## 出力例

```
========================================
      Yoctocc テストスイート
========================================

コンパイラをビルド中...
コンパイラのビルドが完了しました

テスト #1: test/test1.txt
  説明: 基本的な式と制御構文のテスト
  ✓ PASSED: 終了コード 100 (期待値: 100)

テスト #2: test/test2.txt
  説明: 正常終了のテスト(return 0)
  ✓ PASSED: 終了コード 0 (期待値: 0)

========================================
      テスト結果サマリー
========================================
総テスト数:   2
成功:         2
失敗:         0

すべてのテストが成功しました!
```

## 終了コード

- `0` - すべてのテストが成功
- `1` - 一部またはすべてのテストが失敗

## Tips

- テストファイルの期待値を確認するには:
  ```bash
  make clean; make INPUT=test/testX.txt; make run; echo $?
  ```

- 個別のテストファイルをデバッグするには:
  ```bash
  make clean
  make INPUT=test/testX.txt
  cat ./build/program.asm  # アセンブリを確認
  make run
  echo $?                   # 終了コードを確認
  ```
